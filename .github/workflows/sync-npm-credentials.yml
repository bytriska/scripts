name: Sync NPM Credentials
run-name: Syncing NPM Token to Repositories (Initiated by @${{ github.actor }})

on:
  workflow_dispatch:

jobs:
  credentials-sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Validate NPM Credentials
        env:
          RAW_NPM_TOKEN: ${{ secrets.NEW_NPM_TOKEN }}
        run: |
          CONFIG_SCOPE=.registryManager.npm
          SHOULD_VERIFY=$(jq -r "$CONFIG_SCOPE.policy.verifyAuthenticity" config.json)
          if [ "$SHOULD_VERIFY" = "true" ]; then
            echo "::notice title=NPM Token Verification::Starting authenticity check for provided token..."
            echo ""//registry.npmjs.org/:_authToken=${RAW_NPM_TOKEN}" > .npmrc"
            if npm whoami; then
              echo "::notice title=NPM Token Verification::Token verified successfully."
              rm .npmrc
            else
              echo "::error title=NPM Token Verification Failed::The secret NEW_NPM_TOKEN is invalid."
              exit 1
            fi
          fi
      - name: Execute Credentials Sync
        id: sync_task
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
          CREDENTIAL_VALUE: ${{ secrets.NEW_NPM_TOKEN }}
        run: |
          CONFIG_SCOPE=.registryManager.npm
          TARGET_SECRET=$(jq -r "$CONFIG_SCOPE.secretName" config.json)
          FORCE_ALL=$(jq -r "$CONFIG_SCOPE.policy.forceUpdateAll" config.json)

          echo "### ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Repository | Status |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- |" >> $GITHUB_STEP_SUMMARY

          ACTIVE_REPOS=$(gh repo list --limit 1000 --source --no-archived --json name --jq '.[].name')
          for REPO_NAME in $ACTIVE_REPOS; do
            IS_ALLOWED=$(jq -r --arg r "$REPO_NAME" "$CONFIG_SCOPE.allowedRepositories | contains([$r])" config.json)
            if [[ "$IS_ALLOWED" = "true" ]] || [[ "$FORCE_ALL" = "true" ]]; then
              echo "Updating: $REPO_NAME"
              gh secret set "$TARGET_SECRET" --repo "${{ github.repository_owner }}/$REPO_NAME" --body "$CREDENTIAL_VALUE"
              echo "| $REPO_NAME | âœ… Updated |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| $REPO_NAME | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
            fi
          done

              


